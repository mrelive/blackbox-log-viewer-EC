name: Create Release Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install --production
      
      - name: Install pkg globally
        run: npm install -g pkg
      
      - name: Build standalone Windows executable
        shell: pwsh
        run: |
          # Build for Windows only - x64
            npm ci
            $tag = "$env:GITHUB_REF" -replace 'refs/tags/', ''
            echo "Using tag $tag for DECODER_RELEASE_TAG"
            $env:DECODER_RELEASE_TAG = $tag
            npm run build:decoder
            # Package the CommonJS bundle (.cjs) to avoid ESM import errors, embedding tag via env
            pkg decoder-entry.cjs --targets node18-win-x64 --output bbl-decode.exe --public --compress GZip
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: bbl-decode.exe
          body: |
            ## Blackbox Decoder Release - Windows
            
            ### Download
            - **Windows**: Download `bbl-decode.exe` and run it (64-bit)
            
            ### Quick Start
            ```
            bbl-decode.exe flight.bbl output.csv
            ```
            
            **No Node.js installation required!** This is a fully standalone executable with Node.js bundled inside.
            
            ### Usage Examples
            ```bash
            # Convert BBL to CSV
            bbl-decode.exe flight.bbl output.csv
            
            # Convert to JSON
            bbl-decode.exe flight.bbl output.json --format json
            
            # Show help
            bbl-decode.exe --help
            ```
            
            ### What's New
            - ✅ Standalone Windows executable
            - ✅ No dependencies - Node.js 18 bundled inside
            - ✅ JSON and CSV output formats
            - ✅ GPL v3 compliant
            
            ### Requirements
            - **Windows**: 10/11 (64-bit)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
