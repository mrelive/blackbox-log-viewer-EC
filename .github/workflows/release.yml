name: Create Release Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install --production
      
      - name: Install pkg globally
        run: npm install -g pkg
      
      - name: Build standalone Windows executable
        run: |
          # Build for Windows only - x64
          pkg cli-convert.js \
            --targets node18-win-x64 \
            --output bbl-decode \
            --public \
            --compress GZip
      
      - name: Create Windows release package
        run: |
          mkdir -p bbl-decoder-windows
          cp bbl-decode.exe bbl-decoder-windows/
          cp LICENSE bbl-decoder-windows/
          cp -r bin bbl-decoder-windows/
          cp -r src bbl-decoder-windows/
          
          cat > bbl-decoder-windows/README.txt << 'EOF'
          Blackbox Decoder - Windows Standalone
          
          QUICK START:
          bbl-decode.exe flight.bbl output.csv
          
          NO INSTALLATION NEEDED!
          
          USAGE:
          bbl-decode.exe flight.bbl output.csv
          bbl-decode.exe flight.bbl output.json --format json
          bbl-decode.exe --help
          
          LICENSE: GPLv3 (see LICENSE file)
          Repository: https://github.com/mrelive/blackbox-log-viewer-EC
          EOF
          
          zip -r bbl-decoder-windows.zip bbl-decoder-windows
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: bbl-decoder-windows.zip
          body: |
            ## Blackbox Decoder Release - Windows
            
            ### Download
            - **Windows**: `bbl-decoder-windows.zip` (64-bit)
            
            ### Quick Start
            ```
            bbl-decode.exe flight.bbl output.csv
            ```
            
            **No Node.js installation required!** This is a fully standalone executable with Node.js bundled inside.
            
            ### Usage Examples
            ```bash
            # Convert BBL to CSV
            bbl-decode.exe flight.bbl output.csv
            
            # Convert to JSON
            bbl-decode.exe flight.bbl output.json --format json
            
            # Show help
            bbl-decode.exe --help
            ```
            
            ### What's New
            - ✅ Standalone Windows executable
            - ✅ No dependencies - Node.js 18 bundled inside
            - ✅ JSON and CSV output formats
            - ✅ GPL v3 compliant
            
            ### Requirements
            - **Windows**: 10/11 (64-bit)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
